function getFirstElement(a){for(var b=0;a&&b<a.length;b++)if(isTag(a[b]))return a[b]}function getAttribFunc(a,b){var c={name:a,value:b};return function(a){return checkAttrib(a,c)}}function getChildFunc(a){return function(b){return!!getParent(b)&&a(b)}}function verifyArgs(a,b,c){if(null===c){if(a.length>1)throw new SyntaxError("pseudo-selector :"+b+" requires an argument")}else if(1===a.length)throw new SyntaxError("pseudo-selector :"+b+" doesn't have any arguments")}var DomUtils=require("domutils"),isTag=DomUtils.isTag,getText=DomUtils.getText,getParent=DomUtils.getParent,getChildren=DomUtils.getChildren,getSiblings=DomUtils.getSiblings,hasAttrib=DomUtils.hasAttrib,getName=DomUtils.getName,getAttribute=DomUtils.getAttributeValue,getNCheck=require("nth-check"),checkAttrib=require("./attributes.js").rules.equals,BaseFuncs=require("boolbase"),trueFunc=BaseFuncs.trueFunc,falseFunc=BaseFuncs.falseFunc,filters={contains:function(a,b){return'"'!==b.charAt(0)&&"'"!==b.charAt(0)||b.charAt(0)!==b.substr(-1)||(b=b.slice(1,-1)),function(c){return a(c)&&getText(c).indexOf(b)>=0}},"nth-child":function(a,b){var c=getNCheck(b);return c===falseFunc?c:c===trueFunc?getChildFunc(a):function(b){for(var d=getSiblings(b),e=0,f=0;e<d.length;e++)if(isTag(d[e])){if(d[e]===b)break;f++}return c(f)&&a(b)}},"nth-last-child":function(a,b){var c=getNCheck(b);return c===falseFunc?c:c===trueFunc?getChildFunc(a):function(b){for(var d=getSiblings(b),e=0,f=d.length-1;f>=0;f--)if(isTag(d[f])){if(d[f]===b)break;e++}return c(e)&&a(b)}},"nth-of-type":function(a,b){var c=getNCheck(b);return c===falseFunc?c:c===trueFunc?getChildFunc(a):function(b){for(var d=getSiblings(b),e=0,f=0;f<d.length;f++)if(isTag(d[f])){if(d[f]===b)break;getName(d[f])===getName(b)&&e++}return c(e)&&a(b)}},"nth-last-of-type":function(a,b){var c=getNCheck(b);return c===falseFunc?c:c===trueFunc?getChildFunc(a):function(b){for(var d=getSiblings(b),e=0,f=d.length-1;f>=0;f--)if(isTag(d[f])){if(d[f]===b)break;getName(d[f])===getName(b)&&e++}return c(e)&&a(b)}},checkbox:getAttribFunc("type","checkbox"),file:getAttribFunc("type","file"),password:getAttribFunc("type","password"),radio:getAttribFunc("type","radio"),reset:getAttribFunc("type","reset"),image:getAttribFunc("type","image"),submit:getAttribFunc("type","submit")},pseudos={root:function(a){return!getParent(a)},empty:function(a){return!getChildren(a).some(function(a){return isTag(a)||"text"===a.type})},"first-child":function(a){return getFirstElement(getSiblings(a))===a},"last-child":function(a){for(var b=getSiblings(a),c=b.length-1;c>=0;c--){if(b[c]===a)return!0;if(isTag(b[c]))break}return!1},"first-of-type":function(a){for(var b=getSiblings(a),c=0;c<b.length;c++)if(isTag(b[c])){if(b[c]===a)return!0;if(getName(b[c])===getName(a))break}return!1},"last-of-type":function(a){for(var b=getSiblings(a),c=b.length-1;c>=0;c--)if(isTag(b[c])){if(b[c]===a)return!0;if(getName(b[c])===getName(a))break}return!1},"only-of-type":function(a){for(var b=getSiblings(a),c=0,d=b.length;d>c;c++)if(isTag(b[c])){if(b[c]===a)continue;if(getName(b[c])===getName(a))return!1}return!0},"only-child":function(a){for(var b=getSiblings(a),c=0;c<b.length;c++)if(isTag(b[c])&&b[c]!==a)return!1;return!0},selected:function(a){if(hasAttrib(a,"selected"))return!0;if("option"!==getName(a))return!1;var b=getParent(a);if(!b||"select"!==getName(b)||hasAttrib(b,"multiple"))return!1;for(var c=getChildren(b),d=!1,e=0;e<c.length;e++)if(isTag(c[e]))if(c[e]===a)d=!0;else{if(!d)return!1;if(hasAttrib(c[e],"selected"))return!1}return d},disabled:function(a){return hasAttrib(a,"disabled")},enabled:function(a){return!hasAttrib(a,"disabled")},checked:function(a){return hasAttrib(a,"checked")||pseudos.selected(a)},parent:function(a){return!pseudos.empty(a)},header:function(a){var b=getName(a);return"h1"===b||"h2"===b||"h3"===b||"h4"===b||"h5"===b||"h6"===b},button:function(a){var b=getName(a);return"button"===b||"input"===b&&"button"===getAttribute(a,"type")},input:function(a){var b=getName(a);return"input"===b||"textarea"===b||"select"===b||"button"===b},text:function(a){var b;return"input"===getName(a)&&(!(b=getAttribute(a,"type"))||"text"===b.toLowerCase())}},re_CSS3=/^(?:(?:nth|last|first|only)-(?:child|of-type)|root|empty|(?:en|dis)abled|checked|not)$/;module.exports={compile:function(a,b,c){var d=b.name,e=b.data;if(c&&c.strict&&!re_CSS3.test(d))throw SyntaxError(":"+d+" isn't part of CSS3");if("function"==typeof filters[d])return verifyArgs(filters[d],d,e),filters[d](a,e,c);if("function"==typeof pseudos[d]){var f=pseudos[d];return verifyArgs(f,d,e),a===trueFunc?f:function(b){return f(b,e)&&a(b)}}throw new SyntaxError("unmatched pseudo-class :"+d)},filters:filters,pseudos:pseudos};