function WriteReq(a,b,c){this.chunk=a,this.encoding=b,this.callback=c}function WritableState(a,b){var c=require("./_stream_duplex");a=a||{};var d=a.highWaterMark,e=a.objectMode?16:16384;this.highWaterMark=d||0===d?d:e,this.objectMode=!!a.objectMode,b instanceof c&&(this.objectMode=this.objectMode||!!a.writableObjectMode),this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var f=a.decodeStrings===!1;this.decodeStrings=!f,this.defaultEncoding=a.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(a){onwrite(b,a)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1}function Writable(a){var b=require("./_stream_duplex");return this instanceof Writable||this instanceof b?(this._writableState=new WritableState(a,this),this.writable=!0,void Stream.call(this)):new Writable(a)}function writeAfterEnd(a,b,c){var d=new Error("write after end");a.emit("error",d),process.nextTick(function(){c(d)})}function validChunk(a,b,c,d){var e=!0;if(!(util.isBuffer(c)||util.isString(c)||util.isNullOrUndefined(c)||b.objectMode)){var f=new TypeError("Invalid non-string/buffer chunk");a.emit("error",f),process.nextTick(function(){d(f)}),e=!1}return e}function decodeChunk(a,b,c){return!a.objectMode&&a.decodeStrings!==!1&&util.isString(b)&&(b=new Buffer(b,c)),b}function writeOrBuffer(a,b,c,d,e){c=decodeChunk(b,c,d),util.isBuffer(c)&&(d="buffer");var f=b.objectMode?1:c.length;b.length+=f;var g=b.length<b.highWaterMark;return g||(b.needDrain=!0),b.writing||b.corked?b.buffer.push(new WriteReq(c,d,e)):doWrite(a,b,!1,f,c,d,e),g}function doWrite(a,b,c,d,e,f,g){b.writelen=d,b.writecb=g,b.writing=!0,b.sync=!0,c?a._writev(e,b.onwrite):a._write(e,f,b.onwrite),b.sync=!1}function onwriteError(a,b,c,d,e){c?process.nextTick(function(){b.pendingcb--,e(d)}):(b.pendingcb--,e(d)),a._writableState.errorEmitted=!0,a.emit("error",d)}function onwriteStateUpdate(a){a.writing=!1,a.writecb=null,a.length-=a.writelen,a.writelen=0}function onwrite(a,b){var c=a._writableState,d=c.sync,e=c.writecb;if(onwriteStateUpdate(c),b)onwriteError(a,c,d,b,e);else{var f=needFinish(a,c);f||c.corked||c.bufferProcessing||!c.buffer.length||clearBuffer(a,c),d?process.nextTick(function(){afterWrite(a,c,f,e)}):afterWrite(a,c,f,e)}}function afterWrite(a,b,c,d){c||onwriteDrain(a,b),b.pendingcb--,d(),finishMaybe(a,b)}function onwriteDrain(a,b){0===b.length&&b.needDrain&&(b.needDrain=!1,a.emit("drain"))}function clearBuffer(a,b){if(b.bufferProcessing=!0,a._writev&&b.buffer.length>1){for(var c=[],d=0;d<b.buffer.length;d++)c.push(b.buffer[d].callback);b.pendingcb++,doWrite(a,b,!0,b.length,b.buffer,"",function(a){for(var d=0;d<c.length;d++)b.pendingcb--,c[d](a)}),b.buffer=[]}else{for(var d=0;d<b.buffer.length;d++){var e=b.buffer[d],f=e.chunk,g=e.encoding,h=e.callback,i=b.objectMode?1:f.length;if(doWrite(a,b,!1,i,f,g,h),b.writing){d++;break}}d<b.buffer.length?b.buffer=b.buffer.slice(d):b.buffer.length=0}b.bufferProcessing=!1}function needFinish(a,b){return b.ending&&0===b.length&&!b.finished&&!b.writing}function prefinish(a,b){b.prefinished||(b.prefinished=!0,a.emit("prefinish"))}function finishMaybe(a,b){var c=needFinish(a,b);return c&&(0===b.pendingcb?(prefinish(a,b),b.finished=!0,a.emit("finish")):prefinish(a,b)),c}function endWritable(a,b,c){b.ending=!0,finishMaybe(a,b),c&&(b.finished?process.nextTick(c):a.once("finish",c)),b.ended=!0}module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(a,b,c){var d=this._writableState,e=!1;return util.isFunction(b)&&(c=b,b=null),util.isBuffer(a)?b="buffer":b||(b=d.defaultEncoding),util.isFunction(c)||(c=function(){}),d.ended?writeAfterEnd(this,d,c):validChunk(this,d,a,c)&&(d.pendingcb++,e=writeOrBuffer(this,d,a,b,c)),e},Writable.prototype.cork=function(){var a=this._writableState;a.corked++},Writable.prototype.uncork=function(){var a=this._writableState;a.corked&&(a.corked--,a.writing||a.corked||a.finished||a.bufferProcessing||!a.buffer.length||clearBuffer(this,a))},Writable.prototype._write=function(a,b,c){c(new Error("not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(a,b,c){var d=this._writableState;util.isFunction(a)?(c=a,a=null,b=null):util.isFunction(b)&&(c=b,b=null),util.isNullOrUndefined(a)||this.write(a,b),d.corked&&(d.corked=1,this.uncork()),d.ending||d.finished||endWritable(this,d,c)};