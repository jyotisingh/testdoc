function whitespace(a){return" "===a||"\n"===a||"	"===a||"\f"===a||"\r"===a}function characterState(a,b){return function(c){c===a&&(this._state=b)}}function ifElseState(a,b,c){var d=a.toLowerCase();return a===d?function(a){a===d?this._state=b:(this._state=c,this._index--)}:function(e){e===d||e===a?this._state=b:(this._state=c,this._index--)}}function consumeSpecialNameChar(a,b){var c=a.toLowerCase();return function(d){d===c||d===a?this._state=b:(this._state=IN_TAG_NAME,this._index--)}}function Tokenizer(a,b){this._state=TEXT,this._buffer="",this._sectionStart=0,this._index=0,this._bufferOffset=0,this._baseState=TEXT,this._special=SPECIAL_NONE,this._cbs=b,this._running=!0,this._ended=!1,this._xmlMode=!(!a||!a.xmlMode),this._decodeEntities=!(!a||!a.decodeEntities)}module.exports=Tokenizer;var decodeCodePoint=require("entities/lib/decode_codepoint.js"),entityMap=require("entities/maps/entities.json"),legacyMap=require("entities/maps/legacy.json"),xmlMap=require("entities/maps/xml.json"),i=0,TEXT=i++,BEFORE_TAG_NAME=i++,IN_TAG_NAME=i++,IN_SELF_CLOSING_TAG=i++,BEFORE_CLOSING_TAG_NAME=i++,IN_CLOSING_TAG_NAME=i++,AFTER_CLOSING_TAG_NAME=i++,BEFORE_ATTRIBUTE_NAME=i++,IN_ATTRIBUTE_NAME=i++,AFTER_ATTRIBUTE_NAME=i++,BEFORE_ATTRIBUTE_VALUE=i++,IN_ATTRIBUTE_VALUE_DQ=i++,IN_ATTRIBUTE_VALUE_SQ=i++,IN_ATTRIBUTE_VALUE_NQ=i++,BEFORE_DECLARATION=i++,IN_DECLARATION=i++,IN_PROCESSING_INSTRUCTION=i++,BEFORE_COMMENT=i++,IN_COMMENT=i++,AFTER_COMMENT_1=i++,AFTER_COMMENT_2=i++,BEFORE_CDATA_1=i++,BEFORE_CDATA_2=i++,BEFORE_CDATA_3=i++,BEFORE_CDATA_4=i++,BEFORE_CDATA_5=i++,BEFORE_CDATA_6=i++,IN_CDATA=i++,AFTER_CDATA_1=i++,AFTER_CDATA_2=i++,BEFORE_SPECIAL=i++,BEFORE_SPECIAL_END=i++,BEFORE_SCRIPT_1=i++,BEFORE_SCRIPT_2=i++,BEFORE_SCRIPT_3=i++,BEFORE_SCRIPT_4=i++,BEFORE_SCRIPT_5=i++,AFTER_SCRIPT_1=i++,AFTER_SCRIPT_2=i++,AFTER_SCRIPT_3=i++,AFTER_SCRIPT_4=i++,AFTER_SCRIPT_5=i++,BEFORE_STYLE_1=i++,BEFORE_STYLE_2=i++,BEFORE_STYLE_3=i++,BEFORE_STYLE_4=i++,AFTER_STYLE_1=i++,AFTER_STYLE_2=i++,AFTER_STYLE_3=i++,AFTER_STYLE_4=i++,BEFORE_ENTITY=i++,BEFORE_NUMERIC_ENTITY=i++,IN_NAMED_ENTITY=i++,IN_NUMERIC_ENTITY=i++,IN_HEX_ENTITY=i++,j=0,SPECIAL_NONE=j++,SPECIAL_SCRIPT=j++,SPECIAL_STYLE=j++;Tokenizer.prototype._stateText=function(a){"<"===a?(this._index>this._sectionStart&&this._cbs.ontext(this._getSection()),this._state=BEFORE_TAG_NAME,this._sectionStart=this._index):this._decodeEntities&&this._special===SPECIAL_NONE&&"&"===a&&(this._index>this._sectionStart&&this._cbs.ontext(this._getSection()),this._baseState=TEXT,this._state=BEFORE_ENTITY,this._sectionStart=this._index)},Tokenizer.prototype._stateBeforeTagName=function(a){"/"===a?this._state=BEFORE_CLOSING_TAG_NAME:">"===a||this._special!==SPECIAL_NONE||whitespace(a)?this._state=TEXT:"!"===a?(this._state=BEFORE_DECLARATION,this._sectionStart=this._index+1):"?"===a?(this._state=IN_PROCESSING_INSTRUCTION,this._sectionStart=this._index+1):"<"===a?(this._cbs.ontext(this._getSection()),this._sectionStart=this._index):(this._state=this._xmlMode||"s"!==a&&"S"!==a?IN_TAG_NAME:BEFORE_SPECIAL,this._sectionStart=this._index)},Tokenizer.prototype._stateInTagName=function(a){("/"===a||">"===a||whitespace(a))&&(this._emitToken("onopentagname"),this._state=BEFORE_ATTRIBUTE_NAME,this._index--)},Tokenizer.prototype._stateBeforeCloseingTagName=function(a){whitespace(a)||(">"===a?this._state=TEXT:this._special!==SPECIAL_NONE?"s"===a||"S"===a?this._state=BEFORE_SPECIAL_END:(this._state=TEXT,this._index--):(this._state=IN_CLOSING_TAG_NAME,this._sectionStart=this._index))},Tokenizer.prototype._stateInCloseingTagName=function(a){(">"===a||whitespace(a))&&(this._emitToken("onclosetag"),this._state=AFTER_CLOSING_TAG_NAME,this._index--)},Tokenizer.prototype._stateAfterCloseingTagName=function(a){">"===a&&(this._state=TEXT,this._sectionStart=this._index+1)},Tokenizer.prototype._stateBeforeAttributeName=function(a){">"===a?(this._cbs.onopentagend(),this._state=TEXT,this._sectionStart=this._index+1):"/"===a?this._state=IN_SELF_CLOSING_TAG:whitespace(a)||(this._state=IN_ATTRIBUTE_NAME,this._sectionStart=this._index)},Tokenizer.prototype._stateInSelfClosingTag=function(a){">"===a?(this._cbs.onselfclosingtag(),this._state=TEXT,this._sectionStart=this._index+1):whitespace(a)||(this._state=BEFORE_ATTRIBUTE_NAME,this._index--)},Tokenizer.prototype._stateInAttributeName=function(a){("="===a||"/"===a||">"===a||whitespace(a))&&(this._cbs.onattribname(this._getSection()),this._sectionStart=-1,this._state=AFTER_ATTRIBUTE_NAME,this._index--)},Tokenizer.prototype._stateAfterAttributeName=function(a){"="===a?this._state=BEFORE_ATTRIBUTE_VALUE:"/"===a||">"===a?(this._cbs.onattribend(),this._state=BEFORE_ATTRIBUTE_NAME,this._index--):whitespace(a)||(this._cbs.onattribend(),this._state=IN_ATTRIBUTE_NAME,this._sectionStart=this._index)},Tokenizer.prototype._stateBeforeAttributeValue=function(a){'"'===a?(this._state=IN_ATTRIBUTE_VALUE_DQ,this._sectionStart=this._index+1):"'"===a?(this._state=IN_ATTRIBUTE_VALUE_SQ,this._sectionStart=this._index+1):whitespace(a)||(this._state=IN_ATTRIBUTE_VALUE_NQ,this._sectionStart=this._index,this._index--)},Tokenizer.prototype._stateInAttributeValueDoubleQuotes=function(a){'"'===a?(this._emitToken("onattribdata"),this._cbs.onattribend(),this._state=BEFORE_ATTRIBUTE_NAME):this._decodeEntities&&"&"===a&&(this._emitToken("onattribdata"),this._baseState=this._state,this._state=BEFORE_ENTITY,this._sectionStart=this._index)},Tokenizer.prototype._stateInAttributeValueSingleQuotes=function(a){"'"===a?(this._emitToken("onattribdata"),this._cbs.onattribend(),this._state=BEFORE_ATTRIBUTE_NAME):this._decodeEntities&&"&"===a&&(this._emitToken("onattribdata"),this._baseState=this._state,this._state=BEFORE_ENTITY,this._sectionStart=this._index)},Tokenizer.prototype._stateInAttributeValueNoQuotes=function(a){whitespace(a)||">"===a?(this._emitToken("onattribdata"),this._cbs.onattribend(),this._state=BEFORE_ATTRIBUTE_NAME,this._index--):this._decodeEntities&&"&"===a&&(this._emitToken("onattribdata"),this._baseState=this._state,this._state=BEFORE_ENTITY,this._sectionStart=this._index)},Tokenizer.prototype._stateBeforeDeclaration=function(a){this._state="["===a?BEFORE_CDATA_1:"-"===a?BEFORE_COMMENT:IN_DECLARATION},Tokenizer.prototype._stateInDeclaration=function(a){">"===a&&(this._cbs.ondeclaration(this._getSection()),this._state=TEXT,this._sectionStart=this._index+1)},Tokenizer.prototype._stateInProcessingInstruction=function(a){">"===a&&(this._cbs.onprocessinginstruction(this._getSection()),this._state=TEXT,this._sectionStart=this._index+1)},Tokenizer.prototype._stateBeforeComment=function(a){"-"===a?(this._state=IN_COMMENT,this._sectionStart=this._index+1):this._state=IN_DECLARATION},Tokenizer.prototype._stateInComment=function(a){"-"===a&&(this._state=AFTER_COMMENT_1)},Tokenizer.prototype._stateAfterComment1=function(a){"-"===a?this._state=AFTER_COMMENT_2:this._state=IN_COMMENT},Tokenizer.prototype._stateAfterComment2=function(a){">"===a?(this._cbs.oncomment(this._buffer.substring(this._sectionStart,this._index-2)),this._state=TEXT,this._sectionStart=this._index+1):"-"!==a&&(this._state=IN_COMMENT)},Tokenizer.prototype._stateBeforeCdata1=ifElseState("C",BEFORE_CDATA_2,IN_DECLARATION),Tokenizer.prototype._stateBeforeCdata2=ifElseState("D",BEFORE_CDATA_3,IN_DECLARATION),Tokenizer.prototype._stateBeforeCdata3=ifElseState("A",BEFORE_CDATA_4,IN_DECLARATION),Tokenizer.prototype._stateBeforeCdata4=ifElseState("T",BEFORE_CDATA_5,IN_DECLARATION),Tokenizer.prototype._stateBeforeCdata5=ifElseState("A",BEFORE_CDATA_6,IN_DECLARATION),Tokenizer.prototype._stateBeforeCdata6=function(a){"["===a?(this._state=IN_CDATA,this._sectionStart=this._index+1):(this._state=IN_DECLARATION,this._index--)},Tokenizer.prototype._stateInCdata=function(a){"]"===a&&(this._state=AFTER_CDATA_1)},Tokenizer.prototype._stateAfterCdata1=characterState("]",AFTER_CDATA_2),Tokenizer.prototype._stateAfterCdata2=function(a){">"===a?(this._cbs.oncdata(this._buffer.substring(this._sectionStart,this._index-2)),this._state=TEXT,this._sectionStart=this._index+1):"]"!==a&&(this._state=IN_CDATA)},Tokenizer.prototype._stateBeforeSpecial=function(a){"c"===a||"C"===a?this._state=BEFORE_SCRIPT_1:"t"===a||"T"===a?this._state=BEFORE_STYLE_1:(this._state=IN_TAG_NAME,this._index--)},Tokenizer.prototype._stateBeforeSpecialEnd=function(a){this._special!==SPECIAL_SCRIPT||"c"!==a&&"C"!==a?this._special!==SPECIAL_STYLE||"t"!==a&&"T"!==a?this._state=TEXT:this._state=AFTER_STYLE_1:this._state=AFTER_SCRIPT_1},Tokenizer.prototype._stateBeforeScript1=consumeSpecialNameChar("R",BEFORE_SCRIPT_2),Tokenizer.prototype._stateBeforeScript2=consumeSpecialNameChar("I",BEFORE_SCRIPT_3),Tokenizer.prototype._stateBeforeScript3=consumeSpecialNameChar("P",BEFORE_SCRIPT_4),Tokenizer.prototype._stateBeforeScript4=consumeSpecialNameChar("T",BEFORE_SCRIPT_5),Tokenizer.prototype._stateBeforeScript5=function(a){("/"===a||">"===a||whitespace(a))&&(this._special=SPECIAL_SCRIPT),this._state=IN_TAG_NAME,this._index--},Tokenizer.prototype._stateAfterScript1=ifElseState("R",AFTER_SCRIPT_2,TEXT),Tokenizer.prototype._stateAfterScript2=ifElseState("I",AFTER_SCRIPT_3,TEXT),Tokenizer.prototype._stateAfterScript3=ifElseState("P",AFTER_SCRIPT_4,TEXT),Tokenizer.prototype._stateAfterScript4=ifElseState("T",AFTER_SCRIPT_5,TEXT),Tokenizer.prototype._stateAfterScript5=function(a){">"===a||whitespace(a)?(this._special=SPECIAL_NONE,this._state=IN_CLOSING_TAG_NAME,this._sectionStart=this._index-6,this._index--):this._state=TEXT},Tokenizer.prototype._stateBeforeStyle1=consumeSpecialNameChar("Y",BEFORE_STYLE_2),Tokenizer.prototype._stateBeforeStyle2=consumeSpecialNameChar("L",BEFORE_STYLE_3),Tokenizer.prototype._stateBeforeStyle3=consumeSpecialNameChar("E",BEFORE_STYLE_4),Tokenizer.prototype._stateBeforeStyle4=function(a){("/"===a||">"===a||whitespace(a))&&(this._special=SPECIAL_STYLE),this._state=IN_TAG_NAME,this._index--},Tokenizer.prototype._stateAfterStyle1=ifElseState("Y",AFTER_STYLE_2,TEXT),Tokenizer.prototype._stateAfterStyle2=ifElseState("L",AFTER_STYLE_3,TEXT),Tokenizer.prototype._stateAfterStyle3=ifElseState("E",AFTER_STYLE_4,TEXT),Tokenizer.prototype._stateAfterStyle4=function(a){">"===a||whitespace(a)?(this._special=SPECIAL_NONE,this._state=IN_CLOSING_TAG_NAME,this._sectionStart=this._index-5,this._index--):this._state=TEXT},Tokenizer.prototype._stateBeforeEntity=ifElseState("#",BEFORE_NUMERIC_ENTITY,IN_NAMED_ENTITY),Tokenizer.prototype._stateBeforeNumericEntity=ifElseState("X",IN_HEX_ENTITY,IN_NUMERIC_ENTITY),Tokenizer.prototype._parseNamedEntityStrict=function(){if(this._sectionStart+1<this._index){var a=this._buffer.substring(this._sectionStart+1,this._index),b=this._xmlMode?xmlMap:entityMap;b.hasOwnProperty(a)&&(this._emitPartial(b[a]),this._sectionStart=this._index+1)}},Tokenizer.prototype._parseLegacyEntity=function(){var a=this._sectionStart+1,b=this._index-a;for(b>6&&(b=6);b>=2;){var c=this._buffer.substr(a,b);if(legacyMap.hasOwnProperty(c))return this._emitPartial(legacyMap[c]),void(this._sectionStart+=b+1);b--}},Tokenizer.prototype._stateInNamedEntity=function(a){";"===a?(this._parseNamedEntityStrict(),this._sectionStart+1<this._index&&!this._xmlMode&&this._parseLegacyEntity(),this._state=this._baseState):("a">a||a>"z")&&("A">a||a>"Z")&&("0">a||a>"9")&&(this._xmlMode||this._sectionStart+1===this._index||(this._baseState!==TEXT?"="!==a&&this._parseNamedEntityStrict():this._parseLegacyEntity()),this._state=this._baseState,this._index--)},Tokenizer.prototype._decodeNumericEntity=function(a,b){var c=this._sectionStart+a;if(c!==this._index){var d=this._buffer.substring(c,this._index),e=parseInt(d,b);this._emitPartial(decodeCodePoint(e)),this._sectionStart=this._index}else this._sectionStart--;this._state=this._baseState},Tokenizer.prototype._stateInNumericEntity=function(a){";"===a?(this._decodeNumericEntity(2,10),this._sectionStart++):("0">a||a>"9")&&(this._xmlMode?this._state=this._baseState:this._decodeNumericEntity(2,10),this._index--)},Tokenizer.prototype._stateInHexEntity=function(a){";"===a?(this._decodeNumericEntity(3,16),this._sectionStart++):("a">a||a>"f")&&("A">a||a>"F")&&("0">a||a>"9")&&(this._xmlMode?this._state=this._baseState:this._decodeNumericEntity(3,16),this._index--)},Tokenizer.prototype._cleanup=function(){this._sectionStart<0?(this._buffer="",this._index=0,this._bufferOffset+=this._index):this._running&&(this._state===TEXT?(this._sectionStart!==this._index&&this._cbs.ontext(this._buffer.substr(this._sectionStart)),this._buffer="",this._index=0,this._bufferOffset+=this._index):this._sectionStart===this._index?(this._buffer="",this._index=0,this._bufferOffset+=this._index):(this._buffer=this._buffer.substr(this._sectionStart),this._index-=this._sectionStart,this._bufferOffset+=this._sectionStart),this._sectionStart=0)},Tokenizer.prototype.write=function(a){this._ended&&this._cbs.onerror(Error(".write() after done!")),this._buffer+=a,this._parse()},Tokenizer.prototype._parse=function(){for(;this._index<this._buffer.length&&this._running;){var a=this._buffer.charAt(this._index);this._state===TEXT?this._stateText(a):this._state===BEFORE_TAG_NAME?this._stateBeforeTagName(a):this._state===IN_TAG_NAME?this._stateInTagName(a):this._state===BEFORE_CLOSING_TAG_NAME?this._stateBeforeCloseingTagName(a):this._state===IN_CLOSING_TAG_NAME?this._stateInCloseingTagName(a):this._state===AFTER_CLOSING_TAG_NAME?this._stateAfterCloseingTagName(a):this._state===IN_SELF_CLOSING_TAG?this._stateInSelfClosingTag(a):this._state===BEFORE_ATTRIBUTE_NAME?this._stateBeforeAttributeName(a):this._state===IN_ATTRIBUTE_NAME?this._stateInAttributeName(a):this._state===AFTER_ATTRIBUTE_NAME?this._stateAfterAttributeName(a):this._state===BEFORE_ATTRIBUTE_VALUE?this._stateBeforeAttributeValue(a):this._state===IN_ATTRIBUTE_VALUE_DQ?this._stateInAttributeValueDoubleQuotes(a):this._state===IN_ATTRIBUTE_VALUE_SQ?this._stateInAttributeValueSingleQuotes(a):this._state===IN_ATTRIBUTE_VALUE_NQ?this._stateInAttributeValueNoQuotes(a):this._state===BEFORE_DECLARATION?this._stateBeforeDeclaration(a):this._state===IN_DECLARATION?this._stateInDeclaration(a):this._state===IN_PROCESSING_INSTRUCTION?this._stateInProcessingInstruction(a):this._state===BEFORE_COMMENT?this._stateBeforeComment(a):this._state===IN_COMMENT?this._stateInComment(a):this._state===AFTER_COMMENT_1?this._stateAfterComment1(a):this._state===AFTER_COMMENT_2?this._stateAfterComment2(a):this._state===BEFORE_CDATA_1?this._stateBeforeCdata1(a):this._state===BEFORE_CDATA_2?this._stateBeforeCdata2(a):this._state===BEFORE_CDATA_3?this._stateBeforeCdata3(a):this._state===BEFORE_CDATA_4?this._stateBeforeCdata4(a):this._state===BEFORE_CDATA_5?this._stateBeforeCdata5(a):this._state===BEFORE_CDATA_6?this._stateBeforeCdata6(a):this._state===IN_CDATA?this._stateInCdata(a):this._state===AFTER_CDATA_1?this._stateAfterCdata1(a):this._state===AFTER_CDATA_2?this._stateAfterCdata2(a):this._state===BEFORE_SPECIAL?this._stateBeforeSpecial(a):this._state===BEFORE_SPECIAL_END?this._stateBeforeSpecialEnd(a):this._state===BEFORE_SCRIPT_1?this._stateBeforeScript1(a):this._state===BEFORE_SCRIPT_2?this._stateBeforeScript2(a):this._state===BEFORE_SCRIPT_3?this._stateBeforeScript3(a):this._state===BEFORE_SCRIPT_4?this._stateBeforeScript4(a):this._state===BEFORE_SCRIPT_5?this._stateBeforeScript5(a):this._state===AFTER_SCRIPT_1?this._stateAfterScript1(a):this._state===AFTER_SCRIPT_2?this._stateAfterScript2(a):this._state===AFTER_SCRIPT_3?this._stateAfterScript3(a):this._state===AFTER_SCRIPT_4?this._stateAfterScript4(a):this._state===AFTER_SCRIPT_5?this._stateAfterScript5(a):this._state===BEFORE_STYLE_1?this._stateBeforeStyle1(a):this._state===BEFORE_STYLE_2?this._stateBeforeStyle2(a):this._state===BEFORE_STYLE_3?this._stateBeforeStyle3(a):this._state===BEFORE_STYLE_4?this._stateBeforeStyle4(a):this._state===AFTER_STYLE_1?this._stateAfterStyle1(a):this._state===AFTER_STYLE_2?this._stateAfterStyle2(a):this._state===AFTER_STYLE_3?this._stateAfterStyle3(a):this._state===AFTER_STYLE_4?this._stateAfterStyle4(a):this._state===BEFORE_ENTITY?this._stateBeforeEntity(a):this._state===BEFORE_NUMERIC_ENTITY?this._stateBeforeNumericEntity(a):this._state===IN_NAMED_ENTITY?this._stateInNamedEntity(a):this._state===IN_NUMERIC_ENTITY?this._stateInNumericEntity(a):this._state===IN_HEX_ENTITY?this._stateInHexEntity(a):this._cbs.onerror(Error("unknown _state"),this._state),this._index++}this._cleanup()},Tokenizer.prototype.pause=function(){this._running=!1},Tokenizer.prototype.resume=function(){this._running=!0,this._index<this._buffer.length&&this._parse(),this._ended&&this._finish()},Tokenizer.prototype.end=function(a){this._ended&&this._cbs.onerror(Error(".end() after done!")),a&&this.write(a),this._ended=!0,this._running&&this._finish()},Tokenizer.prototype._finish=function(){this._sectionStart<this._index&&this._handleTrailingData(),this._cbs.onend()},Tokenizer.prototype._handleTrailingData=function(){var a=this._buffer.substr(this._sectionStart);this._state===IN_CDATA||this._state===AFTER_CDATA_1||this._state===AFTER_CDATA_2?this._cbs.oncdata(a):this._state===IN_COMMENT||this._state===AFTER_COMMENT_1||this._state===AFTER_COMMENT_2?this._cbs.oncomment(a):this._state!==IN_NAMED_ENTITY||this._xmlMode?this._state!==IN_NUMERIC_ENTITY||this._xmlMode?this._state!==IN_HEX_ENTITY||this._xmlMode?this._state!==IN_TAG_NAME&&this._state!==BEFORE_ATTRIBUTE_NAME&&this._state!==BEFORE_ATTRIBUTE_VALUE&&this._state!==AFTER_ATTRIBUTE_NAME&&this._state!==IN_ATTRIBUTE_NAME&&this._state!==IN_ATTRIBUTE_VALUE_SQ&&this._state!==IN_ATTRIBUTE_VALUE_DQ&&this._state!==IN_ATTRIBUTE_VALUE_NQ&&this._state!==IN_CLOSING_TAG_NAME&&this._cbs.ontext(a):(this._decodeNumericEntity(3,16),this._sectionStart<this._index&&(this._state=this._baseState,this._handleTrailingData())):(this._decodeNumericEntity(2,10),this._sectionStart<this._index&&(this._state=this._baseState,this._handleTrailingData())):(this._parseLegacyEntity(),this._sectionStart<this._index&&(this._state=this._baseState,this._handleTrailingData()))},Tokenizer.prototype.reset=function(){Tokenizer.call(this,{xmlMode:this._xmlMode,decodeEntities:this._decodeEntities},this._cbs)},Tokenizer.prototype.getAbsoluteIndex=function(){return this._bufferOffset+this._index},Tokenizer.prototype._getSection=function(){return this._buffer.substring(this._sectionStart,this._index)},Tokenizer.prototype._emitToken=function(a){this._cbs[a](this._getSection()),this._sectionStart=-1},Tokenizer.prototype._emitPartial=function(a){this._baseState!==TEXT?this._cbs.onattribdata(a):this._cbs.ontext(a)};