var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,cloneDom=utils.cloneDom,slice=Array.prototype.slice;exports._makeDomArray=function(a,b){return null==a?[]:a.cheerio?b?cloneDom(a.get(),a.options):a.get():Array.isArray(a)?_.flatten(a.map(function(a){return this._makeDomArray(a,b)},this)):"string"==typeof a?evaluate(a,this.options):b?cloneDom([a]):[a]};var _insert=function(a){return function(){var b=slice.call(arguments),c=this.length-1;return domEach(this,function(d,e){var f,g;g="function"==typeof b[0]?b[0].call(e,d,$.html(e.children)):b,f=this._makeDomArray(g,c>d),a(f,e.children,e)})}},uniqueSplice=function(a,b,c,d,e){var f,g,h,i,j,k=[b,c].concat(d),l=a[b-1]||null,m=a[b]||null;for(f=0,g=d.length;g>f;++f)i=d[f],j=i.parent||i.root,h=j&&j.children.indexOf(d[f]),j&&h>-1&&(j.children.splice(h,1),e===j&&b>h&&k[0]--),i.root=null,i.parent=e,i.prev&&(i.prev.next=i.next||null),i.next&&(i.next.prev=i.prev||null),i.prev=d[f-1]||l,i.next=d[f+1]||m;return l&&(l.next=d[0]),m&&(m.prev=d[d.length-1]),a.splice.apply(a,k)};exports.append=_insert(function(a,b,c){uniqueSplice(b,b.length,0,a,c)}),exports.prepend=_insert(function(a,b,c){uniqueSplice(b,0,0,a,c)}),exports.after=function(){var a=slice.call(arguments),b=this.length-1;return domEach(this,function(c,d){var e=d.parent||d.root;if(e){var f,g,h=e.children,i=h.indexOf(d);0>i||(f="function"==typeof a[0]?a[0].call(d,c,$.html(d.children)):a,g=this._makeDomArray(f,b>c),uniqueSplice(h,i+1,0,g,e))}}),this},exports.insertAfter=function(a){var b=[],c=this;return"string"==typeof a&&(a=this.constructor.call(this.constructor,a,null,this._originalRoot)),a=this._makeDomArray(a),c.remove(),domEach(a,function(a,d){var e=c._makeDomArray(c.clone()),f=d.parent||d.root;if(f){var g=f.children,h=g.indexOf(d);0>h||(uniqueSplice(g,h+1,0,e,f),b.push(e))}}),this.constructor.call(this.constructor,this._makeDomArray(b))},exports.before=function(){var a=slice.call(arguments),b=this.length-1;return domEach(this,function(c,d){var e=d.parent||d.root;if(e){var f,g,h=e.children,i=h.indexOf(d);0>i||(f="function"==typeof a[0]?a[0].call(d,c,$.html(d.children)):a,g=this._makeDomArray(f,b>c),uniqueSplice(h,i,0,g,e))}}),this},exports.insertBefore=function(a){var b=[],c=this;return"string"==typeof a&&(a=this.constructor.call(this.constructor,a,null,this._originalRoot)),a=this._makeDomArray(a),c.remove(),domEach(a,function(a,d){var e=c._makeDomArray(c.clone()),f=d.parent||d.root;if(f){var g=f.children,h=g.indexOf(d);0>h||(uniqueSplice(g,h,0,e,f),b.push(e))}}),this.constructor.call(this.constructor,this._makeDomArray(b))},exports.remove=function(a){var b=this;return a&&(b=b.filter(a)),domEach(b,function(a,b){var c=b.parent||b.root;if(c){var d=c.children,e=d.indexOf(b);0>e||(d.splice(e,1),b.prev&&(b.prev.next=b.next),b.next&&(b.next.prev=b.prev),b.prev=b.next=b.parent=b.root=null)}}),this},exports.replaceWith=function(a){var b=this;return domEach(this,function(c,d){var e=d.parent||d.root;if(e){var f,g=e.children,h=b._makeDomArray("function"==typeof a?a.call(d,c,d):a);updateDOM(h,null),f=g.indexOf(d),uniqueSplice(g,f,1,h,e),d.parent=d.prev=d.next=d.root=null}}),this},exports.empty=function(){return domEach(this,function(a,b){_.each(b.children,function(a){a.next=a.prev=a.parent=null}),b.children.length=0}),this},exports.html=function(a){if(void 0===a)return this[0]&&this[0].children?$.html(this[0].children,this.options):null;var b=this.options;return domEach(this,function(c,d){_.each(d.children,function(a){a.next=a.prev=a.parent=null});var e=a.cheerio?a.clone().get():evaluate(a,b);updateDOM(e,d)}),this},exports.toString=function(){return $.html(this,this.options)},exports.text=function(a){return void 0===a?$.text(this):"function"==typeof a?domEach(this,function(b,c){var d=[c];return exports.text.call(d,a.call(c,b,$.text(d)))}):(domEach(this,function(b,c){_.each(c.children,function(a){a.next=a.prev=a.parent=null});var d={data:a,type:"text",parent:c,prev:null,next:null,children:[]};updateDOM(d,c)}),this)},exports.clone=function(){return this._make(cloneDom(this.get(),this.options))};