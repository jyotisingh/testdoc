var expect=require("expect.js"),_=require("lodash"),htmlparser2=require("htmlparser2"),$=require("../"),fixtures=require("./fixtures"),fruits=fixtures.fruits,food=fixtures.food,script='<script src="script.js" type="text/javascript"></script>',multiclass='<p><a class="btn primary" href="#">Save</a></p>';describe("cheerio",function(){it("should get the version",function(){expect(/\d+\.\d+\.\d+/.test($.version)).to.be.ok()}),it("$(null) should return be empty",function(){expect($(null)).to.be.empty()}),it("$(undefined) should be empty",function(){expect($(void 0)).to.be.empty()}),it("$(null) should be empty",function(){expect($("")).to.be.empty()}),it("$(selector) with no context or root should be empty",function(){expect($(".h2")).to.be.empty(),expect($("#fruits")).to.be.empty()}),it("$(node) : should override previously-loaded nodes",function(){var a=$.load("<div><span></span></div>"),b=a("span")[0],c=a(b);expect(c[0]).to.equal(b)}),it("should be able to create html without a root or context",function(){var a=$("<h2>");expect(a).to.not.be.empty(),expect(a).to.have.length(1),expect(a[0].tagName).to.equal("h2")}),it("should be able to create complicated html",function(){var a=$(script);expect(a).to.not.be.empty(),expect(a).to.have.length(1),expect(a[0].attribs.src).to.equal("script.js"),expect(a[0].attribs.type).to.equal("text/javascript"),expect(a[0].childNodes).to.be.empty()});var a=function(a){expect(a).to.have.length(1),a=a[0],expect(a.parentNode.tagName).to.equal("ul"),expect(a.prev).to.be(null),expect(a.next.attribs["class"]).to.equal("orange"),expect(a.childNodes).to.have.length(1),expect(a.childNodes[0].data).to.equal("Apple")};it("should be able to select .apple with only a context",function(){var b=$(".apple",fruits);a(b)}),it("should be able to select .apple with a node as context",function(){var b=$(".apple",$(fruits)[0]);a(b)}),it("should be able to select .apple with only a root",function(){var b=$(".apple",null,fruits);a(b)}),it("should be able to select an id",function(){var a=$("#fruits",null,fruits);expect(a).to.have.length(1),expect(a[0].attribs.id).to.equal("fruits")}),it("should be able to select a tag",function(){var a=$("ul",fruits);expect(a).to.have.length(1),expect(a[0].tagName).to.equal("ul")}),it("should accept a node reference as a context",function(){var a=$("<div><span></span></div>");expect($("span",a[0])).to.have.length(1)}),it("should accept an array of node references as a context",function(){var a=$("<div><span></span></div>");expect($("span",a.toArray())).to.have.length(1)}),it("should select only elements inside given context (Issue #193)",function(){var a=$.load(food),b=a("#fruits"),c=a("li",b);expect(c).to.have.length(3)}),it("should be able to select multiple tags",function(){var a=$("li",null,fruits);expect(a).to.have.length(3);var b=["apple","orange","pear"];a.each(function(a,c){expect(c.attribs["class"]).to.equal(b[a])})}),it('should be able to do: $("#fruits .apple")',function(){var b=$("#fruits .apple",fruits);a(b)}),it('should be able to do: $("li.apple")',function(){var b=$("li.apple",fruits);a(b)}),it("should be able to select by attributes",function(){var b=$("li[class=apple]",fruits);a(b)}),it('should be able to select multiple classes: $(".btn.primary")',function(){var a=$(".btn.primary",multiclass);expect(a).to.have.length(1),expect(a[0].childNodes[0].data).to.equal("Save")}),it("should not create a top-level node",function(){var a=$("* div","<div>");expect(a).to.have.length(0)}),it('should be able to select multiple elements: $(".apple, #fruits")',function(){var b=$(".apple, #fruits",fruits);expect(b).to.have.length(2);var c=_.filter(b,function(a){return"apple"===a.attribs["class"]}),d=_.filter(b,function(a){return"fruits"===a.attribs.id});a(c),expect(d[0].attribs.id).to.equal("fruits")}),it("should select first element $(:first)"),it('should be able to select immediate children: $("#fruits > .pear")',function(){var a=$(food);$(".pear",a).append('<li class="pear">Another Pear!</li>'),expect($("#fruits .pear",a)).to.have.length(2);var b=$("#fruits > .pear",a);expect(b).to.have.length(1),expect(b.attr("class")).to.equal("pear")}),it('should be able to select immediate children: $(".apple + .pear")',function(){var a=$(".apple + li",fruits);expect(a).to.have.length(1),a=$(".apple + .pear",fruits),expect(a).to.have.length(0),a=$(".apple + .orange",fruits),expect(a).to.have.length(1),expect(a.attr("class")).to.equal("orange")}),it('should be able to select immediate children: $(".apple ~ .pear")',function(){var a=$(".apple ~ li",fruits);expect(a).to.have.length(2),a=$(".apple ~ .pear",fruits),expect(a.attr("class")).to.equal("pear")}),it('should handle wildcards on attributes: $("li[class*=r]")',function(){var a=$("li[class*=r]",fruits);expect(a).to.have.length(2),expect(a.eq(0).attr("class")).to.equal("orange"),expect(a.eq(1).attr("class")).to.equal("pear")}),it('should handle beginning of attr selectors: $("li[class^=o]")',function(){var a=$("li[class^=o]",fruits);expect(a).to.have.length(1),expect(a.eq(0).attr("class")).to.equal("orange")}),it('should handle beginning of attr selectors: $("li[class$=e]")',function(){var a=$("li[class$=e]",fruits);expect(a).to.have.length(2),expect(a.eq(0).attr("class")).to.equal("apple"),expect(a.eq(1).attr("class")).to.equal("orange")}),it("should gracefully degrade on complex, unmatched queries",function(){var a=$("Eastern States Cup #8-fin&nbsp;<br>Downhill&nbsp;");expect(a).to.have.length(0)}),it("(extended Array) should not interfere with prototype methods (issue #119)",function(){var a=[];a.find=a.children=a.each=function(){};var b=$(a);expect(b.find).to.be($.prototype.find),expect(b.children).to.be($.prototype.children),expect(b.each).to.be($.prototype.each)}),describe(".load",function(){it("should generate selections as proper instances",function(){var a=$.load(fruits);expect(a(".apple")).to.be.a(a)}),it("should be able to filter down using the context",function(){var a=$.load(fruits),b=a(".apple","ul"),c=a("li","ul");expect(b).to.have.length(1),expect(c).to.have.length(3)}),it("should allow loading a pre-parsed DOM",function(){var a=htmlparser2.parseDOM(food),b=$.load(a);expect(b("ul")).to.have.length(3)}),it("should render xml in html() when options.xmlMode = true",function(){var a='<MixedCaseTag UPPERCASEATTRIBUTE=""></MixedCaseTag>',b='<MixedCaseTag UPPERCASEATTRIBUTE=""/>',c=$.load(a,{xmlMode:!0});expect(c("MixedCaseTag").get(0).tagName).to.equal("MixedCaseTag"),expect(c.html()).to.be(b)}),it("should render xml in html() when options.xmlMode = true passed to html()",function(){var a='<MixedCaseTag UPPERCASEATTRIBUTE=""></MixedCaseTag>',b='<mixedcasetag uppercaseattribute=""/>',c='<mixedcasetag uppercaseattribute=""></mixedcasetag>',d=$.load(a);expect(d("MixedCaseTag").get(0).tagName).to.equal("mixedcasetag"),expect(d.html()).to.be(c),expect(d.html({xmlMode:!0})).to.be(b)}),it("should respect options on the element level",function(){var a="<!doctype html><html><head><title>Some test</title></head><body><footer><p>Copyright &copy; 2003-2014</p></footer></body></html>",b="<p>Copyright &copy; 2003-2014</p>",c="<p>Copyright &#xA9; 2003-2014</p>",d=$.load(a,{decodeEntities:!1}),e=$.load(a);expect(d("footer").html()).to.be(b),expect(e("footer").html()).to.be(c)}),it("should return a fully-qualified Function",function(){var a=$.load("<div>");expect(a).to.be.a(Function)}),describe("prototype extensions",function(){it("should honor extensions defined on `prototype` property",function(){var a,b=$.load("<div>");b.prototype.myPlugin=function(){return{context:this,args:arguments}},a=b("div"),expect(a.myPlugin).to.be.a("function"),expect(a.myPlugin().context).to.be(a),expect(Array.prototype.slice.call(a.myPlugin(1,2,3).args)).to.eql([1,2,3])}),it("should honor extensions defined on `fn` property",function(){var a,b=$.load("<div>");b.fn.myPlugin=function(){return{context:this,args:arguments}},a=b("div"),expect(a.myPlugin).to.be.a("function"),expect(a.myPlugin().context).to.be(a),expect(Array.prototype.slice.call(a.myPlugin(1,2,3).args)).to.eql([1,2,3])}),it("should isolate extensions between loaded functions",function(){var a=$.load("<div>"),b=$.load("<div>");a.prototype.foo=function(){},expect(b("div").foo).to.be(void 0)})})})});